x-lan-service: &lan-service
  build:
    context: .
    dockerfile: Dockerfile
    target: ${TRANSCRIBER_DOCKER_TARGET:-runtime-lite}
  image: ${TRANSCRIBER_IMAGE:-lan-transcriber:${TRANSCRIBER_VERSION:-local}}
  pull_policy: ${TRANSCRIBER_PULL_POLICY:-never}
  restart: unless-stopped
  environment: &lan-env
    - PYTHONPATH=/app
    - LAN_DATA_ROOT=${LAN_DATA_ROOT:-/data}
    - LAN_RECORDINGS_ROOT=${LAN_RECORDINGS_ROOT:-/data/recordings}
    - LAN_SPEAKER_DB=${LAN_SPEAKER_DB:-/data/db/speaker_bank.yaml}
    - LAN_VOICES_DIR=${LAN_VOICES_DIR:-/data/voices}
    - LAN_UNKNOWN_DIR=${LAN_UNKNOWN_DIR:-/data/recordings/unknown}
    - LAN_TMP_ROOT=${LAN_TMP_ROOT:-/data/tmp}
    - LAN_PROM_SNAPSHOT_PATH=${LAN_PROM_SNAPSHOT_PATH:-/data/metrics.snap}
    - LAN_DB_PATH=${LAN_DB_PATH:-/data/db/app.db}
    - LAN_ENV=${LAN_ENV:-dev}
    - LAN_REDIS_URL=${LAN_REDIS_URL}
    - LAN_RQ_QUEUE_NAME=${LAN_RQ_QUEUE_NAME:-lan-transcriber}
    - LLM_BASE_URL=${LLM_BASE_URL}
    - LLM_API_KEY=${LLM_API_KEY}
    - LLM_MODEL=${LLM_MODEL:-}
    - LLM_TIMEOUT_SECONDS=${LLM_TIMEOUT_SECONDS:-30}
    - FETCH_INTERVAL_SEC=${FETCH_INTERVAL_SEC:-300}
    - TRANSCRIBER_VERSION=${TRANSCRIBER_VERSION:-local}
    - LANG_DEFAULT=${LANG_DEFAULT:-en}
    - QUARANTINE_RETENTION_DAYS=${QUARANTINE_RETENTION_DAYS:-7}
  volumes:
    - lan_cache:/root/.cache
    - /opt/lan_cache/hf:/root/.cache/huggingface
    - /opt/lan_cache/ollama:/root/.ollama
    # Persistent runtime state root: DB, uploads, derived artifacts, logs.
    - ./data:/data
  networks:
    - lan_net

services:
  db:
    <<: *lan-service
    container_name: lan-db
    command: ["python", "-m", "lan_app.db_init"]
    restart: "no"
    healthcheck:
      test: ["CMD", "python", "-m", "lan_app.healthchecks", "db"]
      interval: 30s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: lan-redis
    restart: unless-stopped
    networks:
      - lan_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  api:
    <<: *lan-service
    container_name: lan-api
    command: ["uvicorn", "lan_app.api:app", "--host", "0.0.0.0", "--port", "7860"]
    depends_on:
      - db
      - redis
    ports:
      - "${LAN_API_BIND_HOST:-127.0.0.1}:${LAN_API_PORT:-7860}:7860"
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://127.0.0.1:7860/healthz/app', timeout=5)",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

  worker:
    <<: *lan-service
    container_name: lan-worker
    command: ["python", "-m", "lan_app.worker"]
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD", "python", "-m", "lan_app.healthchecks", "worker"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s

networks:
  lan_net:

volumes:
  lan_cache:
