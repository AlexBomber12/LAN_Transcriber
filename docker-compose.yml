x-lan-service: &lan-service
  build:
    context: .
    dockerfile: Dockerfile
    target: ${TRANSCRIBER_DOCKER_TARGET:-runtime-lite}
  image: ${TRANSCRIBER_IMAGE:-lan-transcriber:${TRANSCRIBER_VERSION:-local}}
  pull_policy: ${TRANSCRIBER_PULL_POLICY:-never}
  restart: unless-stopped
  environment: &lan-env
    - PYTHONPATH=/app
    - LAN_DATA_ROOT=${LAN_DATA_ROOT:-/data}
    - LAN_RECORDINGS_ROOT=${LAN_RECORDINGS_ROOT:-/data/recordings}
    - LAN_SPEAKER_DB=${LAN_SPEAKER_DB:-/data/db/speaker_bank.yaml}
    - LAN_VOICES_DIR=${LAN_VOICES_DIR:-/data/voices}
    - LAN_UNKNOWN_DIR=${LAN_UNKNOWN_DIR:-/data/recordings/unknown}
    - LAN_TMP_ROOT=${LAN_TMP_ROOT:-/data/tmp}
    - LAN_PROM_SNAPSHOT_PATH=${LAN_PROM_SNAPSHOT_PATH:-/data/metrics.snap}
    - LAN_DB_PATH=${LAN_DB_PATH:-/data/db/app.db}
    - LAN_REDIS_URL=${LAN_REDIS_URL:-redis://redis:6379/0}
    - LAN_RQ_QUEUE_NAME=${LAN_RQ_QUEUE_NAME:-lan-transcriber}
    - LLM_BASE_URL=${LLM_BASE_URL}
    - LLM_API_KEY=${LLM_API_KEY}
    - LLM_MODEL=${LLM_MODEL:-}
    - FETCH_INTERVAL_SEC=${FETCH_INTERVAL_SEC:-300}
    - TRANSCRIBER_VERSION=${TRANSCRIBER_VERSION:-local}
    - LANG_DEFAULT=${LANG_DEFAULT:-en}
    - MS_TENANT_ID=${MS_TENANT_ID:-}
    - MS_CLIENT_ID=${MS_CLIENT_ID:-}
    - "MS_SCOPES=${MS_SCOPES:-offline_access Notes.ReadWrite Calendars.Read}"
  volumes:
    - lan_cache:/root/.cache
    - /opt/lan_cache/hf:/root/.cache/huggingface
    - /opt/lan_cache/ollama:/root/.ollama
    - ./data:/data
  networks:
    - lan_net

services:
  db:
    <<: *lan-service
    container_name: lan-db
    command: ["python", "-m", "lan_app.db_init"]
    restart: "no"

  redis:
    image: redis:7-alpine
    container_name: lan-redis
    restart: unless-stopped
    networks:
      - lan_net

  api:
    <<: *lan-service
    container_name: lan-api
    command: ["uvicorn", "lan_app.api:app", "--host", "0.0.0.0", "--port", "7860"]
    depends_on:
      - db
      - redis
    ports:
      - "7860:7860"

  worker:
    <<: *lan-service
    container_name: lan-worker
    command: ["python", "-m", "lan_app.worker"]
    depends_on:
      - db
      - redis

networks:
  lan_net:

volumes:
  lan_cache:
