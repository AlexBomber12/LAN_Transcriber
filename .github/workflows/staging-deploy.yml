name: staging-deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        shell: bash
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
        run: |
          if [ -z "$STAGING_HOST" ] || [ -z "$STAGING_USER" ] || [ -z "$STAGING_SSH_KEY" ]; then
            echo "::error::Missing required secrets STAGING_HOST, STAGING_USER, and STAGING_SSH_KEY"
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install smoke test dependency
        run: python -m pip install --disable-pip-version-check requests

      - name: Ensure SSH folder
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

      - name: Setup known_hosts
        run: ssh-keyscan -H "${{ secrets.STAGING_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy compose files to VPS
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "infra/staging/*,infra/staging/.env.staging.example"
          target: "~/lan-staging"
          strip_components: 2

      - name: Remote docker compose up
        uses: appleboy/ssh-action@v1.0.0
        env:
          STAGING_GHCR_USERNAME: ${{ secrets.STAGING_GHCR_USERNAME }}
          STAGING_GHCR_TOKEN: ${{ secrets.STAGING_GHCR_TOKEN }}
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          envs: STAGING_GHCR_USERNAME,STAGING_GHCR_TOKEN
          script: |
            set -euo pipefail
            cd ~/lan-staging
            mkdir -p data
            if [ -n "${STAGING_GHCR_TOKEN:-}" ]; then
              printf '%s' "$STAGING_GHCR_TOKEN" | docker login ghcr.io -u "${STAGING_GHCR_USERNAME:-alexbomber12}" --password-stdin
            fi
            docker compose pull
            docker compose up -d --remove-orphans

      - name: Smoke test via API
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        run: python scripts/smoke_test.py --base-url "http://${STAGING_HOST}:7860"
