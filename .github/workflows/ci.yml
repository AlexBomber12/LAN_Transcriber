name: tests+nolayer-smoke

on:
  pull_request:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  unit-and-ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      docker:
        image: docker:24.0.9-dind
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: "/certs"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Run lint and tests
        env:
          CI: 'true'
          COVERAGE_THRESHOLD_TRANSCRIBER: '90'
          COVERAGE_THRESHOLD_APP: '75'
        run: scripts/ci.sh
      - name: Prepare smoke image
        id: prepare_smoke
        run: |
          IMAGE_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REF_NAME="${{ github.ref_name }}"
          TAG="${REF_NAME//\//-}"
          IMAGE="ghcr.io/${IMAGE_OWNER}/lan-transcriber:${TAG}"
          echo "Attempting to pull $IMAGE"
          if docker pull "$IMAGE"; then
            echo "SMOKE_IMAGE=$IMAGE" >> "$GITHUB_OUTPUT"
          else
            echo "Image not found: $IMAGE. Skipping smoke test."
          fi
      - name: Docker smoke
        if: steps.prepare_smoke.outputs.SMOKE_IMAGE != ''
        env:
          SMOKE_IMAGE: ${{ steps.prepare_smoke.outputs.SMOKE_IMAGE }}
        run: |
          . .venv-ci/bin/activate
          python -m pytest -q tests/test_docker_smoke.py
