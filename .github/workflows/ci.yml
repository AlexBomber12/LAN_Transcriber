name: tests+nolayer-smoke

on:
  pull_request:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  unit-and-ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      docker:
        image: docker:24.0.9-dind
        options: --privileged
        env:
          DOCKER_TLS_CERTDIR: "/certs"
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r ci-requirements.txt -r requirements.txt \
            --extra-index-url https://download.pytorch.org/whl/cpu
          pip install -e .[test]
      - name: Run pytest
        env:
          CI: 'true'
        run: pytest -q
      - name: Prepare smoke image
        id: prepare_smoke
        run: |
          IMAGE_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REF_NAME="${{ github.ref_name }}"
          TAG="${REF_NAME//\//-}"
          IMAGE="ghcr.io/${IMAGE_OWNER}/lan-transcriber:${TAG}"
          echo "Attempting to pull $IMAGE"
          if docker pull "$IMAGE"; then
            echo "Pulled $IMAGE"
            echo "SMOKE_IMAGE=$IMAGE" >> "$GITHUB_OUTPUT"
          else
            echo "Image not found; building locally"
            docker build -t lan-transcriber-ci -f Dockerfile .
            echo "SMOKE_IMAGE=lan-transcriber-ci" >> "$GITHUB_OUTPUT"
          fi
      - name: Docker smoke
        if: steps.prepare_smoke.outputs.SMOKE_IMAGE != ''
        env:
          SMOKE_IMAGE: ${{ steps.prepare_smoke.outputs.SMOKE_IMAGE }}
          CI: 'true'
        run: |
          python -m pip install -U requests
          pytest -q tests/test_docker_smoke.py
