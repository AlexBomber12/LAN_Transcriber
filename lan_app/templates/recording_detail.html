{% extends "base.html" %}
{% block title %}{{ rec.id[:20] }} – LAN Transcriber{% endblock %}
{% block content %}
<h1>
  Recording: <code>{{ rec.id }}</code>
  &nbsp;<span class="badge s-{{ rec.status }}">{{ rec.status }}</span>
</h1>

<div class="filters" style="margin-bottom:10px">
  <select class="action-sel" style="font-size:12px" data-rid="{{ rec.id }}" onchange="doRecAction(this)">
    <option value="">Actions…</option>
    <option value="requeue">Requeue</option>
    <option value="quarantine">Quarantine</option>
    <option value="delete">Delete</option>
  </select>
  <a href="/recordings" class="btn" style="text-decoration:none">&#8592; Back</a>
</div>

<div class="tabs">
  {% for t in tabs %}
  <a href="/recordings/{{ rec.id }}?tab={{ t }}" class="tab {% if current_tab == t %}active{% endif %}">{{ t|capitalize }}</a>
  {% endfor %}
</div>

<div class="tab-content">

{% if current_tab == 'overview' %}
  {% set summary_data = summary or {} %}
  <div class="info-grid">
    <span class="k">ID</span><span class="v">{{ rec.id }}</span>
    <span class="k">Filename</span><span class="v">{{ rec.source_filename }}</span>
    <span class="k">Source</span><span class="v">{{ rec.source }}</span>
    <span class="k">Status</span><span class="v"><span class="badge s-{{ rec.status }}">{{ rec.status }}</span></span>
    <span class="k">Captured at</span><span class="v">{{ rec.captured_at[:19].replace('T',' ') if rec.captured_at else '—' }}</span>
    <span class="k">Duration</span><span class="v">{% if rec.duration_sec %}{{ rec.duration_sec }}s{% else %}—{% endif %}</span>
    <span class="k">Project ID</span><span class="v">{{ rec.project_id or '—' }}</span>
    <span class="k">Language (auto)</span><span class="v">{{ rec.language_auto or '—' }}</span>
    <span class="k">Transcript language override</span><span class="v">{{ rec.language_override or '—' }}</span>
    <span class="k">Target summary language</span><span class="v">{{ rec.target_summary_language or '—' }}</span>
    <span class="k">Drive file ID</span><span class="v">{{ rec.drive_file_id or '—' }}</span>
    <span class="k">OneNote page ID</span><span class="v">{{ rec.onenote_page_id or '—' }}</span>
    <span class="k">Quarantine reason</span><span class="v">{{ rec.quarantine_reason or '—' }}</span>
    <span class="k">Created at</span><span class="v">{{ rec.created_at[:19].replace('T',' ') if rec.created_at else '—' }}</span>
    <span class="k">Updated at</span><span class="v">{{ rec.updated_at[:19].replace('T',' ') if rec.updated_at else '—' }}</span>
  </div>

  <h2>Topic</h2>
  <p>{{ summary_data.topic or '—' }}</p>

  <h2>Summary</h2>
  {% if summary_data.summary_bullets %}
  <ul>
    {% for bullet in summary_data.summary_bullets %}
    <li>{{ bullet }}</li>
    {% endfor %}
  </ul>
  {% elif summary_data.summary_text %}
  <pre style="white-space:pre-wrap;background:#f8f9ff;border:1px solid #ccd;padding:8px;font:12px/1.4 'Courier New',monospace;max-height:240px;overflow:auto">{{ summary_data.summary_text }}</pre>
  {% else %}
  <p class="placeholder">No summary available yet.</p>
  {% endif %}

  <h2>Emotional Summary</h2>
  <p style="white-space:pre-wrap">{{ summary_data.emotional_summary or '—' }}</p>

{% elif current_tab == 'calendar' %}
  {% set cal = calendar or {} %}
  {% set signals = cal.signals or {} %}

  {% if cal.fetch_error %}
  <p style="margin-bottom:10px;color:#92400e">
    Calendar fetch unavailable: {{ cal.fetch_error }}
  </p>
  {% endif %}

  <h2>Selected Event</h2>
  {% if cal.selected_event %}
  <div class="info-grid">
    <span class="k">Subject</span><span class="v">{{ cal.selected_event.subject }}</span>
    <span class="k">Start</span><span class="v">{{ cal.selected_event.start[:19].replace('T',' ') if cal.selected_event.start else '—' }}</span>
    <span class="k">End</span><span class="v">{{ cal.selected_event.end[:19].replace('T',' ') if cal.selected_event.end else '—' }}</span>
    <span class="k">Organizer</span><span class="v">{{ cal.selected_event.organizer or '—' }}</span>
    <span class="k">Attendees</span><span class="v">{{ (cal.selected_event.attendees or []) | join(', ') or '—' }}</span>
    <span class="k">Location</span><span class="v">{{ cal.selected_event.location or '—' }}</span>
    <span class="k">Score</span><span class="v">{{ '%.3f'|format(cal.selected_confidence or 0.0) }}</span>
  </div>
  {% elif cal.manual_no_event %}
  <p class="placeholder">No event selected (manual override).</p>
  {% else %}
  <p class="placeholder">No event matched yet.</p>
  {% endif %}

  <h2>Extracted Signals</h2>
  <div class="info-grid">
    <span class="k">Title tokens</span><span class="v">{{ (signals.title_tokens or []) | join(', ') or '—' }}</span>
    <span class="k">Attendees</span><span class="v">{{ (signals.attendees or []) | join(', ') or '—' }}</span>
    <span class="k">Organizer</span><span class="v">{{ signals.organizer or '—' }}</span>
  </div>

  <h2>Candidate Events (Top 5)</h2>
  <form method="post" action="/ui/recordings/{{ rec.id }}/calendar/select">
    <table>
      <thead>
        <tr>
          <th>Pick</th>
          <th>Subject</th>
          <th>Start</th>
          <th>End</th>
          <th>Organizer</th>
          <th>Attendees</th>
          <th>Location</th>
          <th>Score</th>
          <th>Rationale</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="radio" name="event_id" value="" {% if not cal.selected_event_id %}checked{% endif %}></td>
          <td colspan="8"><em>No event</em></td>
        </tr>
        {% for c in cal.candidates or [] %}
        <tr>
          <td><input type="radio" name="event_id" value="{{ c.event_id }}" {% if cal.selected_event_id == c.event_id %}checked{% endif %}></td>
          <td title="{{ c.subject }}">{{ c.subject }}</td>
          <td>{{ c.start[:19].replace('T',' ') if c.start else '—' }}</td>
          <td>{{ c.end[:19].replace('T',' ') if c.end else '—' }}</td>
          <td>{{ c.organizer or '—' }}</td>
          <td title="{{ (c.attendees or []) | join(', ') }}">{{ (c.attendees or []) | join(', ') or '—' }}</td>
          <td>{{ c.location or '—' }}</td>
          <td>{{ '%.3f'|format(c.score or 0.0) }}</td>
          <td title="{{ c.rationale }}">{{ c.rationale }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not (cal.candidates or []) %}
    <p class="placeholder">No candidates found in the calendar window.</p>
    {% endif %}
    <div class="filters" style="margin-top:8px">
      <button type="submit" class="btn">Save selection</button>
    </div>
  </form>

{% elif current_tab == 'project' %}
  <p class="placeholder">Project assignment — available after PR-CALENDAR-01.</p>

{% elif current_tab == 'speakers' %}
  <p class="placeholder">Speaker assignments — available after PR-VOICE-01.</p>

{% elif current_tab == 'language' %}
  {% set lang = language or {} %}

  <h2>Detected Languages</h2>
  <div class="info-grid">
    <span class="k">Detected language</span><span class="v">{{ lang.detected_label or '—' }}</span>
    <span class="k">Dominant language</span><span class="v">{{ lang.dominant_label or '—' }}</span>
    <span class="k">Mixed-language meeting</span><span class="v">{{ 'Yes' if lang.is_mixed else 'No' }}</span>
    <span class="k">Current summary target</span><span class="v">{{ lang.target_summary_language_label or '—' }}</span>
    <span class="k">Transcript override</span><span class="v">{{ lang.transcript_language_override_label or '—' }}</span>
  </div>

  <h2>Language Distribution</h2>
  {% if lang.distribution %}
  <table>
    <thead>
      <tr>
        <th>Language</th>
        <th>Share (%)</th>
      </tr>
    </thead>
    <tbody>
      {% for row in lang.distribution %}
      <tr>
        <td>{{ row.label }}</td>
        <td>{{ '%.2f'|format(row.percent) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No language distribution available yet.</p>
  {% endif %}

  <h2>Language Spans</h2>
  {% if lang.spans %}
  <table>
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Language</th>
      </tr>
    </thead>
    <tbody>
      {% for span in lang.spans %}
      <tr>
        <td>{{ '%.3f'|format(span.start) }}</td>
        <td>{{ '%.3f'|format(span.end) }}</td>
        <td>{{ span.label }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No language spans available yet.</p>
  {% endif %}

  <h2>Overrides and Reprocess</h2>
  <form method="post" action="/ui/recordings/{{ rec.id }}/language/settings">
    <div class="form-row">
      <label for="target_summary_language">target_summary_language</label>
      <select id="target_summary_language" name="target_summary_language">
        <option value="" {% if not lang.target_summary_language %}selected{% endif %}>Auto (dominant language)</option>
        {% for opt in lang.options or [] %}
        <option value="{{ opt.code }}" {% if lang.target_summary_language == opt.code %}selected{% endif %}>{{ opt.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-row">
      <label for="transcript_language_override">transcript_language_override</label>
      <select id="transcript_language_override" name="transcript_language_override">
        <option value="">None (auto detect)</option>
        {% for opt in lang.options or [] %}
        <option value="{{ opt.code }}" {% if lang.transcript_language_override == opt.code %}selected{% endif %}>{{ opt.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filters" style="margin-top:8px">
      <button type="submit" class="btn">Save overrides</button>
      <button
        type="submit"
        class="btn"
        formaction="/ui/recordings/{{ rec.id }}/language/resummarize"
      >
        Re-summarize (LLM only)
      </button>
      <button
        type="submit"
        class="btn btn-danger"
        formaction="/ui/recordings/{{ rec.id }}/language/retranscribe"
        onclick="return confirm('Re-transcribe reruns STT and diarization. Continue?')"
      >
        Re-transcribe (STT again)
      </button>
    </div>
  </form>

  {% if lang.summary_preview %}
  <h2>Latest Summary</h2>
  <pre style="white-space:pre-wrap;background:#f8f9ff;border:1px solid #ccd;padding:8px;font:12px/1.4 'Courier New',monospace;max-height:240px;overflow:auto">{{ lang.summary_preview }}</pre>
  {% endif %}

{% elif current_tab == 'metrics' %}
  {% set summary_data = summary or {} %}
  {% set metrics_data = metrics or {} %}
  {% set meeting = metrics_data.meeting or {} %}
  {% set participants = metrics_data.participants or [] %}
  {% set questions = summary_data.questions or {} %}
  {% set question_types = questions.types or {} %}

  <h2>Meeting Metrics</h2>
  <div class="info-grid">
    <span class="k">Total speech time</span><span class="v">{{ '%.1f'|format(meeting.total_speech_time_seconds or 0.0) }}s</span>
    <span class="k">Interruptions</span><span class="v">{{ meeting.total_interruptions or 0 }}</span>
    <span class="k">Questions</span><span class="v">{{ meeting.total_questions or 0 }}</span>
    <span class="k">Decisions</span><span class="v">{{ meeting.decisions_count or 0 }}</span>
    <span class="k">Action items</span><span class="v">{{ meeting.action_items_count or 0 }}</span>
    <span class="k">Actionability</span><span class="v">{{ '%.1f'|format((meeting.actionability_ratio or 0.0) * 100.0) }}%</span>
    <span class="k">Emotional summary</span><span class="v">{{ meeting.emotional_summary or '—' }}</span>
  </div>

  <h2>Participants</h2>
  {% if participants %}
  <table>
    <thead>
      <tr>
        <th>Speaker</th>
        <th>Airtime (s)</th>
        <th>Share (%)</th>
        <th>Turns</th>
        <th>Interruptions done</th>
        <th>Interruptions received</th>
        <th>Questions</th>
        <th>Role</th>
      </tr>
    </thead>
    <tbody>
      {% for row in participants %}
      <tr>
        <td>{{ row.speaker }}</td>
        <td>{{ '%.2f'|format(row.airtime_seconds or 0.0) }}</td>
        <td>{{ '%.2f'|format((row.airtime_share or 0.0) * 100.0) }}</td>
        <td>{{ row.turns or 0 }}</td>
        <td>{{ row.interruptions_done or 0 }}</td>
        <td>{{ row.interruptions_received or 0 }}</td>
        <td>{{ row.questions_count or 0 }}</td>
        <td>{{ row.role_hint or '—' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No participant metrics available yet.</p>
  {% endif %}

  <h2>Decisions</h2>
  {% if summary_data.decisions %}
  <ul>
    {% for decision in summary_data.decisions %}
    <li>{{ decision }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="placeholder">No decisions extracted.</p>
  {% endif %}

  <h2>Action Items</h2>
  {% if summary_data.action_items %}
  <table>
    <thead>
      <tr>
        <th>Task</th>
        <th>Owner</th>
        <th>Deadline</th>
        <th>Confidence</th>
      </tr>
    </thead>
    <tbody>
      {% for item in summary_data.action_items %}
      <tr>
        <td>{{ item.task }}</td>
        <td>{{ item.owner or '—' }}</td>
        <td>{{ item.deadline or '—' }}</td>
        <td>{{ '%.2f'|format(item.confidence or 0.0) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No action items extracted.</p>
  {% endif %}

  <h2>Questions</h2>
  <div class="info-grid">
    <span class="k">Total</span><span class="v">{{ questions.total_count or 0 }}</span>
    <span class="k">Open</span><span class="v">{{ question_types.open or 0 }}</span>
    <span class="k">Yes/No</span><span class="v">{{ question_types.yes_no or 0 }}</span>
    <span class="k">Clarification</span><span class="v">{{ question_types.clarification or 0 }}</span>
    <span class="k">Status</span><span class="v">{{ question_types.status or 0 }}</span>
    <span class="k">Decision-seeking</span><span class="v">{{ question_types.decision_seeking or 0 }}</span>
  </div>
  {% if questions.extracted %}
  <h3>Extracted Questions</h3>
  <ul>
    {% for question in questions.extracted %}
    <li>{{ question }}</li>
    {% endfor %}
  </ul>
  {% endif %}

{% elif current_tab == 'log' %}
  {% if jobs %}
  <table>
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Type</th>
        <th>Status</th>
        <th>Attempt</th>
        <th>Started</th>
        <th>Finished</th>
        <th>Error</th>
      </tr>
    </thead>
    <tbody>
      {% for j in jobs %}
      <tr>
        <td title="{{ j.id }}">{{ j.id[:16] }}…</td>
        <td>{{ j.type }}</td>
        <td><span class="badge s-{{ j.status }}">{{ j.status }}</span></td>
        <td>{{ j.attempt }}</td>
        <td>{{ j.started_at[:19].replace('T',' ') if j.started_at else '—' }}</td>
        <td>{{ j.finished_at[:19].replace('T',' ') if j.finished_at else '—' }}</td>
        <td title="{{ j.error or '' }}">{{ (j.error or '')[:40] }}{% if j.error and j.error|length > 40 %}…{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No jobs for this recording.</p>
  {% endif %}
{% endif %}

</div>
{% endblock %}
