{% extends "base.html" %}
{% block title %}Connections – LAN Transcriber{% endblock %}
{% block content %}
<h1>Connections</h1>

<div class="conn-card">
  <h3>Google Drive (Service Account)</h3>
  <div class="conn-row">
    <span class="dot-na"></span>
    <span style="color:#888">Not configured — available after PR-GDRIVE-INGEST-01.</span>
  </div>
  <div style="font-size:11px;color:#999;margin-top:4px">
    Ingest: Service Account + shared folder (Inbox).<br>
    Credentials: <code>/data/secrets/gdrive_sa.json</code>
  </div>
</div>

<div class="conn-card">
  <h3>Microsoft Graph (Work account)</h3>
  {% if ms.status == "connected" %}
  <div class="conn-row">
    <span class="dot-ok"></span>
    <span>Connected</span>
  </div>
  {% elif ms.status == "expired" %}
  <div class="conn-row">
    <span class="dot-warn"></span>
    <span>Expired — reconnect required.</span>
  </div>
  {% elif ms.status == "error" %}
  <div class="conn-row">
    <span class="dot-err"></span>
    <span>Graph error: {{ ms.error }}</span>
  </div>
  {% else %}
  <div class="conn-row">
    <span class="dot-na"></span>
    <span style="color:#888">Not configured.</span>
  </div>
  {% endif %}
  <div class="info-grid" style="margin-top:8px">
    <div class="k">Tenant</div>
    <div class="v">{{ ms.tenant_id or "—" }}</div>
    <div class="k">Account</div>
    <div class="v">{{ ms.account_display_name or "—" }}</div>
    <div class="k">Requested scopes</div>
    <div class="v">{{ (ms.requested_scopes or []) | join(" ") or "—" }}</div>
    <div class="k">Granted scopes</div>
    <div class="v" id="ms-granted-scopes">{{ (ms.granted_scopes or []) | join(" ") or "—" }}</div>
  </div>
  <div style="font-size:11px;color:#999;margin-top:4px">
    Auth: Delegated OAuth via Device Code Flow.<br>
    Token cache: <code>/data/auth/msal_cache.bin</code>
  </div>
  {% if ms.configured %}
  <div class="conn-row" style="margin-top:8px">
    <button type="button" class="btn" onclick="startMsConnect(false)">Connect</button>
    <button type="button" class="btn" onclick="startMsConnect(true)">Reconnect</button>
    <span id="ms-connect-status" style="color:#666"></span>
  </div>
  <div id="ms-device-flow" style="display:none;border:1px solid #ccd;background:#f8f9ff;padding:8px;margin-top:6px">
    <div class="conn-row"><strong>Code:</strong> <code id="ms-user-code"></code></div>
    <div class="conn-row"><strong>Verify at:</strong> <a id="ms-verify-link" href="#" target="_blank" rel="noreferrer noopener"></a></div>
    <div style="font-size:11px;color:#666" id="ms-flow-message"></div>
  </div>
  {% else %}
  <div style="font-size:11px;color:#999;margin-top:8px">
    Set <code>MS_TENANT_ID</code> and <code>MS_CLIENT_ID</code> to enable Microsoft Graph auth.
  </div>
  {% endif %}
</div>
{% if ms.configured %}
<script>
let msSessionId = null;
let msPollHandle = null;

function setMsStatus(message, isError) {
  var el = document.getElementById('ms-connect-status');
  if (!el) return;
  el.textContent = message || '';
  el.style.color = isError ? '#b42318' : '#666';
}

function stopMsPolling() {
  if (msPollHandle) {
    clearInterval(msPollHandle);
    msPollHandle = null;
  }
}

async function startMsConnect(reconnect) {
  stopMsPolling();
  msSessionId = null;
  setMsStatus('Starting device code flow...', false);

  var url = '/api/connections/ms/connect?reconnect=' + (reconnect ? 'true' : 'false');
  var response = await fetch(url, {method: 'POST'});
  var data = await response.json();
  if (!response.ok) {
    setMsStatus(data.detail || 'Failed to start Microsoft auth.', true);
    return;
  }

  msSessionId = data.session_id;
  document.getElementById('ms-device-flow').style.display = 'block';
  document.getElementById('ms-user-code').textContent = data.user_code || '';

  var verifyUrl = data.verification_uri_complete || data.verification_uri || '';
  var link = document.getElementById('ms-verify-link');
  link.textContent = verifyUrl;
  link.href = verifyUrl || '#';

  document.getElementById('ms-flow-message').textContent = data.message || '';
  setMsStatus('Waiting for authentication...', false);

  msPollHandle = setInterval(pollMsSession, 2000);
  await pollMsSession();
}

async function pollMsSession() {
  if (!msSessionId) return;
  var response = await fetch('/api/connections/ms/connect/' + encodeURIComponent(msSessionId));
  if (!response.ok) {
    stopMsPolling();
    setMsStatus('Auth polling failed.', true);
    return;
  }
  var data = await response.json();
  if (data.status === 'pending') {
    return;
  }

  stopMsPolling();
  if (data.status === 'connected') {
    setMsStatus('Connected. Refreshing...', false);
    window.location.reload();
    return;
  }

  setMsStatus(data.error || 'Authentication failed.', true);
}
</script>
{% endif %}
{% endblock %}
