{% extends "base.html" %}
{% block title %}Connections – LAN Transcriber{% endblock %}
{% block content %}
<h1>Connections</h1>

<div class="conn-card">
  <h3>Google Drive (Service Account)</h3>
  {% if gdrive.configured %}
  <div class="conn-row">
    <span class="dot-ok"></span>
    <span>Configured</span>
  </div>
  <div class="info-grid" style="margin-top:8px">
    <div class="k">Service account key</div>
    <div class="v"><code>{{ gdrive.sa_path }}</code></div>
    <div class="k">Inbox folder ID</div>
    <div class="v"><code>{{ gdrive.folder_id }}</code></div>
  </div>
  <div class="conn-row" style="margin-top:8px">
    <button
      type="button"
      class="btn"
      hx-post="/ui/connections/gdrive/test"
      hx-target="#gdrive-test-result"
      hx-swap="innerHTML"
    >
      Test connection
    </button>
    <button type="button" class="btn" onclick="runIngestNow()">Run ingest now</button>
  </div>
  <div id="gdrive-test-result" style="font-size:11px;color:#666;margin-top:4px"></div>
  <div id="gdrive-ingest-result" style="font-size:11px;color:#666;margin-top:2px"></div>
  {% else %}
  <div class="conn-row">
    <span class="dot-na"></span>
    <span style="color:#888">Not configured.</span>
  </div>
  <div style="font-size:11px;color:#999;margin-top:4px">
    Set <code>GDRIVE_SA_JSON_PATH</code> and <code>GDRIVE_INBOX_FOLDER_ID</code>.
  </div>
  {% endif %}
  <div style="font-size:11px;color:#999;margin-top:4px">
    Ingest: Service Account + shared folder (Inbox).<br>
    Credentials: <code>/data/secrets/gdrive_sa.json</code>
  </div>
</div>

<script>
async function runIngestNow() {
  var out = document.getElementById('gdrive-ingest-result');
  if (!out) return;
  out.style.color = '#666';
  out.textContent = 'Running ingest...';

  var response = null;
  var data = {};
  try {
    response = await fetch('/api/actions/ingest', {method: 'POST'});
    data = await response.json();
  } catch (_err) {
    out.style.color = '#b42318';
    out.textContent = 'Ingest request failed.';
    return;
  }

  if (response.status === 409) {
    out.style.color = '#92400e';
    var retryAfter = data.retry_after_seconds;
    if (typeof retryAfter === 'number') {
      out.textContent = 'Ingest is already running. Retry in ' + retryAfter + 's.';
    } else {
      out.textContent = 'Ingest is already running.';
    }
    return;
  }

  if (!response.ok) {
    out.style.color = '#b42318';
    out.textContent = data.detail || 'Ingest failed.';
    return;
  }

  out.style.color = '#14532d';
  out.textContent = 'Ingest completed. New recordings: ' + (data.count || 0) + '.';
}
</script>

<div class="conn-card">
  <h3>Microsoft Graph (Work account)</h3>
  {% if ms.status == "connected" %}
  <div class="conn-row">
    <span class="dot-ok"></span>
    <span>Connected</span>
  </div>
  {% elif ms.status == "expired" %}
  <div class="conn-row">
    <span class="dot-warn"></span>
    <span>Expired — reconnect required.</span>
  </div>
  {% elif ms.status == "error" %}
  <div class="conn-row">
    <span class="dot-err"></span>
    <span>Graph error: {{ ms.error }}</span>
  </div>
  {% else %}
  <div class="conn-row">
    <span class="dot-na"></span>
    <span style="color:#888">Not configured.</span>
  </div>
  {% endif %}
  <div class="info-grid" style="margin-top:8px">
    <div class="k">Tenant</div>
    <div class="v">{{ ms.tenant_id or "—" }}</div>
    <div class="k">Account</div>
    <div class="v">{{ ms.account_display_name or "—" }}</div>
    <div class="k">Requested scopes</div>
    <div class="v">{{ (ms.requested_scopes or []) | join(" ") or "—" }}</div>
    <div class="k">Granted scopes</div>
    <div class="v" id="ms-granted-scopes">{{ (ms.granted_scopes or []) | join(" ") or "—" }}</div>
  </div>
  <div style="font-size:11px;color:#999;margin-top:4px">
    Auth: Delegated OAuth via Device Code Flow.<br>
    Token cache: <code>/data/auth/msal_cache.bin</code>
  </div>
  {% if ms.configured %}
  <div class="conn-row" style="margin-top:8px">
    <button type="button" class="btn" onclick="startMsConnect(false)">Connect</button>
    <button type="button" class="btn" onclick="startMsConnect(true)">Reconnect</button>
    <span id="ms-connect-status" style="color:#666"></span>
  </div>
  <div id="ms-device-flow" style="display:none;border:1px solid #ccd;background:#f8f9ff;padding:8px;margin-top:6px">
    <div class="conn-row"><strong>Code:</strong> <code id="ms-user-code"></code></div>
    <div class="conn-row"><strong>Verify at:</strong> <a id="ms-verify-link" href="#" target="_blank" rel="noreferrer noopener"></a></div>
    <div style="font-size:11px;color:#666" id="ms-flow-message"></div>
  </div>
  {% else %}
  <div style="font-size:11px;color:#999;margin-top:8px">
    Set <code>MS_TENANT_ID</code> and <code>MS_CLIENT_ID</code> to enable Microsoft Graph auth.
  </div>
  {% endif %}
</div>
{% if ms.configured %}
<script>
let msSessionId = null;
let msPollHandle = null;

function setMsStatus(message, isError) {
  var el = document.getElementById('ms-connect-status');
  if (!el) return;
  el.textContent = message || '';
  el.style.color = isError ? '#b42318' : '#666';
}

function stopMsPolling() {
  if (msPollHandle) {
    clearInterval(msPollHandle);
    msPollHandle = null;
  }
}

async function startMsConnect(reconnect) {
  stopMsPolling();
  msSessionId = null;
  setMsStatus('Starting device code flow...', false);

  var url = '/api/connections/ms/connect?reconnect=' + (reconnect ? 'true' : 'false');
  var response = await fetch(url, {method: 'POST'});
  var data = await response.json();
  if (!response.ok) {
    setMsStatus(data.detail || 'Failed to start Microsoft auth.', true);
    return;
  }

  msSessionId = data.session_id;
  document.getElementById('ms-device-flow').style.display = 'block';
  document.getElementById('ms-user-code').textContent = data.user_code || '';

  var verifyUrl = data.verification_uri_complete || data.verification_uri || '';
  var link = document.getElementById('ms-verify-link');
  link.textContent = verifyUrl;
  link.href = verifyUrl || '#';

  document.getElementById('ms-flow-message').textContent = data.message || '';
  setMsStatus('Waiting for authentication...', false);

  msPollHandle = setInterval(pollMsSession, 2000);
  await pollMsSession();
}

async function pollMsSession() {
  if (!msSessionId) return;
  var response = await fetch('/api/connections/ms/connect/' + encodeURIComponent(msSessionId));
  if (!response.ok) {
    stopMsPolling();
    setMsStatus('Auth polling failed.', true);
    return;
  }
  var data = await response.json();
  if (data.status === 'pending') {
    return;
  }

  stopMsPolling();
  if (data.status === 'connected') {
    setMsStatus('Connected. Refreshing...', false);
    window.location.reload();
    return;
  }

  setMsStatus(data.error || 'Authentication failed.', true);
}
</script>
{% endif %}
{% endblock %}
