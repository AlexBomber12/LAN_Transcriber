{% extends "base.html" %}
{% block title %}Connections â€“ LAN Transcriber{% endblock %}
{% block content %}
<h1>Connections</h1>

<div class="conn-card">
  <h3>Google Drive (Service Account)</h3>
  {% if gdrive.configured %}
  <div class="conn-row">
    <span class="dot-ok"></span>
    <span>Configured</span>
  </div>
  <div class="info-grid" style="margin-top:8px">
    <div class="k">Service account key</div>
    <div class="v"><code>{{ gdrive.sa_path }}</code></div>
    <div class="k">Inbox folder ID</div>
    <div class="v"><code>{{ gdrive.folder_id }}</code></div>
  </div>
  <div class="conn-row" style="margin-top:8px">
    <button
      type="button"
      class="btn"
      hx-post="/ui/connections/gdrive/test"
      hx-target="#gdrive-test-result"
      hx-swap="innerHTML"
    >
      Test connection
    </button>
    <button type="button" class="btn" onclick="runIngestNow()">Run ingest now</button>
  </div>
  <div id="gdrive-test-result" style="font-size:11px;color:#666;margin-top:4px"></div>
  <div id="gdrive-ingest-result" style="font-size:11px;color:#666;margin-top:2px"></div>
  {% else %}
  <div class="conn-row">
    <span class="dot-na"></span>
    <span style="color:#888">Not configured.</span>
  </div>
  <div style="font-size:11px;color:#999;margin-top:4px">
    Set <code>GDRIVE_SA_JSON_PATH</code> and <code>GDRIVE_INBOX_FOLDER_ID</code>.
  </div>
  {% endif %}
  <div style="font-size:11px;color:#999;margin-top:4px">
    Ingest: Service Account + shared folder (Inbox).<br>
    Credentials: <code>/data/secrets/gdrive_sa.json</code>
  </div>
</div>

<script>
async function runIngestNow() {
  var out = document.getElementById('gdrive-ingest-result');
  if (!out) return;
  out.style.color = '#666';
  out.textContent = 'Running ingest...';

  var response = null;
  var data = {};
  try {
    response = await fetch('/api/actions/ingest', {method: 'POST'});
    data = await response.json();
  } catch (_err) {
    out.style.color = '#b42318';
    out.textContent = 'Ingest request failed.';
    return;
  }

  if (response.status === 409) {
    out.style.color = '#92400e';
    var retryAfter = data.retry_after_seconds;
    if (typeof retryAfter === 'number') {
      out.textContent = 'Ingest is already running. Retry in ' + retryAfter + 's.';
    } else {
      out.textContent = 'Ingest is already running.';
    }
    return;
  }

  if (!response.ok) {
    out.style.color = '#b42318';
    out.textContent = data.detail || 'Ingest failed.';
    return;
  }

  out.style.color = '#14532d';
  out.textContent = 'Ingest completed. New recordings: ' + (data.count || 0) + '.';
}
</script>
{% endblock %}
