{% extends "base.html" %}
{% block title %}Calendars – LAN Transcriber{% endblock %}
{% block content %}
<h1>Calendars</h1>

{% if error_message %}
<div style="background:#fee;border:1px solid #f99;color:#700;padding:8px 10px;margin-bottom:10px;max-width:780px">
  {{ error_message }}
</div>
{% endif %}

<div class="section">
  <h2>Add Source</h2>
  <form method="post" action="/calendars/sources" style="background:#fff;border:1px solid #ccc;padding:10px;max-width:780px">
    <div class="form-row">
      <label for="calendar-source-name">Name</label>
      <input id="calendar-source-name" name="name" type="text" required style="min-width:320px">
    </div>
    <div class="form-row">
      <label for="calendar-source-kind">Type</label>
      <select id="calendar-source-kind" name="kind" onchange="toggleCalendarSourceFields(this.value)">
        <option value="url" selected>URL</option>
        <option value="file">File Text</option>
      </select>
    </div>
    <div class="form-row" id="calendar-source-url-row">
      <label for="calendar-source-url">URL</label>
      <input id="calendar-source-url" name="url" type="url" placeholder="https://example.com/calendar.ics" style="min-width:520px">
    </div>
    <div class="form-row" id="calendar-source-file-row" style="display:none;align-items:flex-start">
      <label for="calendar-source-file">ICS text</label>
      <textarea id="calendar-source-file" name="file" rows="6" style="min-width:520px"></textarea>
    </div>
    <button class="btn" type="submit">Save source</button>
  </form>
</div>

<div class="section">
  <h2>Sources</h2>
  {% if sources %}
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Configured</th>
        <th>Last sync</th>
        <th>Last error</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for source in sources %}
      <tr>
        <td>{{ source.name }}</td>
        <td>{{ source.kind }}</td>
        <td>
          {% if source.kind == "url" %}
          {% if source.url_configured %}{{ source.url_host or "Configured" }}{% else %}Missing{% endif %}
          {% else %}
          {% if source.file_configured %}Configured{% else %}Missing{% endif %}
          {% endif %}
        </td>
        <td>{{ source.last_synced_at[:19].replace('T', ' ') if source.last_synced_at else '—' }}</td>
        <td title="{{ source.last_error or '' }}">{{ source.last_error or '—' }}</td>
        <td>
          <form method="post" action="/calendars/sources/{{ source.id }}/sync">
            <button class="btn" type="submit">Sync now</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No calendar sources configured.</p>
  {% endif %}
</div>

<div class="section">
  <h2>Events</h2>
  <form class="filters" method="get" action="/calendars">
    <label for="events-from">From</label>
    <input id="events-from" type="date" name="from" value="{{ date_from }}">
    <label for="events-to">To</label>
    <input id="events-to" type="date" name="to" value="{{ date_to }}">
    <label for="events-source-id">Source</label>
    <select id="events-source-id" name="source_id">
      <option value="">All</option>
      {% for source in sources %}
      <option value="{{ source.id }}" {% if selected_source_id == source.id %}selected{% endif %}>{{ source.name }}</option>
      {% endfor %}
    </select>
    <button class="btn" type="submit">Load</button>
  </form>

  {% if events %}
  <table>
    <thead>
      <tr>
        <th>Start</th>
        <th>End</th>
        <th>Summary</th>
        <th>Location</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody>
      {% for event in events %}
      <tr>
        <td>{{ event.starts_at[:19].replace('T', ' ') }}</td>
        <td>{{ event.ends_at[:19].replace('T', ' ') }}</td>
        <td title="{{ event.summary or '' }}">{{ event.summary or '—' }}</td>
        <td title="{{ event.location or '' }}">{{ event.location or '—' }}</td>
        <td>{{ event.source_name or ('#' ~ event.source_id) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="placeholder">No events in this date range.</p>
  {% endif %}
</div>

<script>
function toggleCalendarSourceFields(kind) {
  var isFile = kind === "file";
  var urlRow = document.getElementById("calendar-source-url-row");
  var fileRow = document.getElementById("calendar-source-file-row");
  if (!urlRow || !fileRow) {
    return;
  }
  urlRow.style.display = isFile ? "none" : "flex";
  fileRow.style.display = isFile ? "flex" : "none";
}
</script>
{% endblock %}
